
<SCRIPT>
<!--
function displayWindow(url, width, height) {
        var Win = window.open(url,"displayWindow",'width=' + width +
	',height=' + height + ',resizable=1,scrollbars=yes');
	}
	//-->
	</SCRIPT>



<FONT FACE="Arial,Helvetica" SIZE="-1">
To access the contents, click the chapter and section titles.
</FONT>
<P>
<B>Developing Java Enterprise Applications</B>
<FONT SIZE="-1">
<BR>
<I>(Publisher: John Wiley & Sons, Inc.)</I>
<BR>
Author(s): Stephen Asbury ; Scott R. Weiner
<BR>
ISBN: 0471327565
<BR>
Publication Date: 02/01/99
</FONT>
<P>
<Script language="JavaScript">
function isIE4() 
{
    return( navigator.appName.indexOf("Microsoft") != -1 && (navigator.appVersion.charAt(0)=='4') );
 }
function bookMarkit()
{
        var url="http://www.itknowledge.com/PSUser/EWBookMarks.html?url="+window.location+"&isbn=0";
	parent.location.href=url;
        //var win = window.open(url,"myitk");
        //if(!isIE4())
        //       win.focus();

}
</Script>
<a href="javascript:bookMarkit();"><img src="/images/bookmarkit.gif" border=0 alt="Bookmark It" width=97 height=23></a>

<P>
<form name="Search" method="GET" action="http://search.earthweb.com/search97/search_redir.cgi">

<INPUT TYPE="hidden" NAME="Action" VALUE="Search">
<INPUT TYPE="hidden" NAME="SearchPage" VALUE="http://search.earthweb.com/search97/samples/forms/srchdemo.htm">
<INPUT TYPE="hidden" NAME="Collection" VALUE="ITK">
<INPUT TYPE="hidden" NAME="ResultTemplate" VALUE="itk-simple-intrabook.hts">
<INPUT TYPE="hidden" NAME="ViewTemplate" VALUE="view.hts">

<font face="arial, helvetica" size=2><b>Search this book:</b></font><br>
<INPUT NAME="queryText" size=50 VALUE="">&nbsp;<input type="submit" name="submitbutton" value="Go!">
<INPUT type=hidden NAME="section_on" VALUE="on">
<INPUT type=hidden NAME="section" VALUE="http://www.itknowledge.com/reference/standard/0471327565/">

</form>


<!-- Empty Reference Subhead -->

<!--ISBN=0471327565//-->
<!--TITLE=Developing Java Enterprise Applications//-->
<!--AUTHOR=Stephen Asbury//-->
<!--AUTHOR=Scott R. Weiner//-->
<!--PUBLISHER=Wiley Computer Publishing//-->
<!--CHAPTER=16//-->
<!--PAGES=434-441//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//-->

<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="16-12.html">Previous</A></TD>
<TD><A HREF="../ewtoc.html">Table of Contents</A></TD>
<TD><A HREF="16-14.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<P><BR></P>
<P>Because the container is managing the persistence, the fields in this bean are marked as public to give the container access to them.
</P>
<!-- CODE //-->
<PRE>
package containercart;

import javax.ejb.*;
import java.io.Serializable;
import java.util.*;

import containercart.*;

public class ShoppingCartBean implements EntityBean
{
    transient protected EntityContext context;
    transient boolean isModified;
    public Vector items;
    public String cartName;

    public void ejbActivate()
    {
    }

    public void ejbRemove()
    {
    }

    public void ejbPassivate()
    {
    }

    public void ejbLoad()
    {
        //container managed
    }

    public void ejbStore()
    {
        //container managed
    }
    public void setEntityContext(EntityContext ctx)
    {
        context = ctx;
    }

    public void unsetEntityContext()
    {
        context = null;
    }
    <B>public CartPK ejbCreate(String nm)
    {
         CartPK pk = new CartPK();
         pk.cartName = nm;

         cartName = nm;
         return pk;
    }</B>

    public void ejbPostCreate(String nm)
    {
    }

    <B>public boolean isModified()</B>
    {
        return isModified;
    }

    <B>public void addItem(String item)</B>
    {
        if(items == null)
            items = new Vector();

        isModified = true;
        items.addElement(item);
    }

    <B>public Object[] getItems()</B>
    {
        if(items == null)
            items = new Vector();

        Object[] retVal = new Object[items.size()];
        items.copyInto(retVal);

        return retVal;
    }
}
</PRE>
<!-- END CODE //-->
<P>Next, let&#146;s look at the same bean, but with bean-managed persistence.
</P>
<H4 ALIGN="LEFT"><A NAME="Heading26"></A><FONT COLOR="#000077">Example of Bean-Managed Persistence</FONT></H4>
<P>The shopping cart bean is implemented using bean-managed persistence by serializing the list of items to a file named after the cart. This makes the find process as simple as looking for a file with the specified name. If the file is not found, a FindException is thrown. Loading the bean requires reading the items list from file, and saving is accomplished by writing it to file. Because everything is file based, the response to a remove request is to remove the file.
</P>
<!-- CODE //-->
<PRE>
package beancart;

import javax.ejb.*;
import java.io.*;
import java.util.*;
import java.rmi.*;

import beancart.*;

public class <B>ShoppingCartBean</B> implements <B>EntityBean</B>
{
    transient protected EntityContext context;
    transient boolean isModified;
    public Vector items;
    public String cartName;

    public void ejbActivate()
    {
    }
</PRE>
<!-- END CODE //-->
<P>The remove method checks whether the given cart name is associated with a file and, if so, the file is removed.
</P>
<!-- CODE //-->
<PRE>
    <B>public void ejbRemove() throws RemoteException</B>
    {
     try
     {
         File file = fileForCartName(cartName);

         if((file != null)&amp&amp(cartName != null))
         {
             if(file.exists())
             {
                    <B>file.delete();</B>
             }
         }
     }
     catch(Exception exp)
     {
         items = null;
         throw new RemoteException(&#147;File doesn&#146;t exist.&#148;);
     }
    }
    public void ejbPassivate()
    {
    }
</PRE>
<!-- END CODE //-->
<P>The bean is loaded by finding the appropriate file and, if it exists, reading the items Vector from the file. If the file is not available, a new Vector is created.
</P>
<!-- CODE //-->
<PRE>
    <B>public void ejbLoad() throws RemoteException</B>
    {
        try
        {
            File file = fileForCartName(cartName);

            if((file != null)&amp&amp(cartName != null))
            {
                if(file.exists())
                {
                   FileInputStream fileIn;
                   ObjectInputStream objIn;

                   fileIn = new FileInputStream(file);
                   objIn = new ObjectInputStream(fileIn);

                   try
                   {
                        <B>items = (Vector) objIn.readObject();</B>
                   }
                   finally
                   {
                        objIn.close();
                   }
                }
                else if(items == null)
                {
                   items = new Vector();
                }
            }
     }
     catch(Exception exp)
     {
         items = null;
         throw new RemoteException(&#147;Unable to load.&#148;);
     }
    }
</PRE>
<!-- END CODE //-->
<P>The bean is stored only if it is modified to improve performance. Storing is a process of getting the correct file name and serializing the item&#146;s Vector to the file.
</P>
<!-- CODE //-->
<PRE>
    <B>public void ejbStore() throws RemoteException</B>
    {
     if(!isModified()) return;

     try
     {
         File file = fileForCartName(cartName);

         if((file != null)&amp&amp(cartName != null))
         {
             if(file.exists())
             {
                 FileOutputStream fileOut;
                 ObjectOutputStream objOut;

                 fileOut = new FileOutputStream(file);
                 objOut = new ObjectOutputStream(fileOut);

                 try
                 {
                        <B>objOut.writeObject(items);</B>
                 }
                 finally
                 {
                        objOut.close();
                 }
             }
          }
      }
      catch(Exception exp)
      {
         throw new RemoteException(&#147;Unable to store.&#148;);
      }
    }
</PRE>
<!-- END CODE //-->
<P>For simplicity, the bean keeps track of its context in case it needs to use it in another method.
</P>
<!-- CODE //-->
<PRE>
    public void setEntityContext(EntityContext ctx)
    {
        context = ctx;
    }

    public void unsetEntityContext()
    {
        context = null;
    }
</PRE>
<!-- END CODE //-->
<P>All entity beans should return an instance of their primary keys from their create methods. The cart bean both returns this key and initializes its instance variables when created.
</P>
<!-- CODE //-->
<PRE>
    <B>public CartPK ejbCreate(String nm) throws CreateException</B>
    {
         CartPK pk = new CartPK();
         pk.cartName = nm;

         items = new Vector();
         cartName = nm;
         return pk;
    }

    public void ejbPostCreate(String nm)
    {
    }
</PRE>
<!-- END CODE //-->
<P>To find a bean by primary key, the cart first checks the key&#146;s cartName and associates it with a file. If the file is unavailable, the bean throws a FinderException to indicate that the request failed. If the file exists, the bean initializes its instance variables to the specified cart name and waits to have the load method called to initialize the contents.
</P>
<!-- CODE //-->
<PRE>
    <B>public CartPK ejbFindByPrimaryKey(CartPK pk)</B>
        <B>throws FinderException</B>
    {
         File file = null;
         String ctName = null;
         CartPK retVal = null;

         if(pk != null) ctName = pk.cartName;

         if(ctName != null) file = fileForCartName(ctName);

         if((file != null)
             &amp&amp(ctName != null)
             &amp&amp(file.exists()))
         {
             retVal = pk;
             cartName = ctName;
         }
         else
         {
             <B>throw new FinderException(&#147;Couldn&#146;t locate bean.&#148;);</B>
         }

         return retVal;
    }
</PRE>
<!-- END CODE //-->
<P>The isModified method is used to check whether the bean&#146;s data has changed.
</P>
<!-- CODE SNIP //-->
<PRE>
    public boolean isModified()
    {
        return isModified;
    }
</PRE>
<!-- END CODE SNIP //-->
<P>This bean provides methods for adding items to the cart and getting the items in the cart:
</P>
<!-- CODE //-->
<PRE>
    public void addItem(String item)
    {
        isModified = true;
        items.addElement(item);
    }

    public Object[] getItems()
    {
        Object[] retVal = new Object[items.size()];
        items.copyInto(retVal);

         return retVal;
    }
</PRE>
<!-- END CODE //-->
<P>The following example hard codes the location for cart files. All carts are stored in a file in the temp directory based on their cart name.
</P>
<!-- CODE SNIP //-->
<PRE>
    protected File fileForCartName(String nm)
    {
        return new File(&#147;c:\\temp\\&#148;&#43;nm&#43;&#147;.ser&#148;);
    }
}
</PRE>
<!-- END CODE SNIP //-->
<P>This shopping cart bean has a pretty simple implementation for findByPrimaryKey. In general, the implementation for this method should perform the following steps:
</P>
<DL>
<DD><B>1.</B>&nbsp;&nbsp;Try to locate a bean with the specified key.
<DD><B>2.</B>&nbsp;&nbsp;If the bean exists, return the primary key for it.
<DD><B>3.</B>&nbsp;&nbsp;If the bean does not exist, throw a FinderException.
</DL>
<P>When a database is used for persistence, the first step is accomplished by querying the database. Other persistence mechanisms require their own techniques for testing whether a bean exists by primary key.
</P><P><BR></P>
<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="16-12.html">Previous</A></TD>
<TD><A HREF="../ewtoc.html">Table of Contents</A></TD>
<TD><A HREF="16-14.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>


<!-- 
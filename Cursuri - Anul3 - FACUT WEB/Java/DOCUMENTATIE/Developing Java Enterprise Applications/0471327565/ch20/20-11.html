
<SCRIPT>
<!--
function displayWindow(url, width, height) {
        var Win = window.open(url,"displayWindow",'width=' + width +
	',height=' + height + ',resizable=1,scrollbars=yes');
	}
	//-->
	</SCRIPT>



<FONT FACE="Arial,Helvetica" SIZE="-1">
To access the contents, click the chapter and section titles.
</FONT>
<P>
<B>Developing Java Enterprise Applications</B>
<FONT SIZE="-1">
<BR>
<I>(Publisher: John Wiley & Sons, Inc.)</I>
<BR>
Author(s): Stephen Asbury ; Scott R. Weiner
<BR>
ISBN: 0471327565
<BR>
Publication Date: 02/01/99
</FONT>
<P>
<Script language="JavaScript">
function isIE4() 
{
    return( navigator.appName.indexOf("Microsoft") != -1 && (navigator.appVersion.charAt(0)=='4') );
 }
function bookMarkit()
{
        var url="http://www.itknowledge.com/PSUser/EWBookMarks.html?url="+window.location+"&isbn=0";
	parent.location.href=url;
        //var win = window.open(url,"myitk");
        //if(!isIE4())
        //       win.focus();

}
</Script>
<a href="javascript:bookMarkit();"><img src="/images/bookmarkit.gif" border=0 alt="Bookmark It" width=97 height=23></a>

<P>
<form name="Search" method="GET" action="http://search.earthweb.com/search97/search_redir.cgi">

<INPUT TYPE="hidden" NAME="Action" VALUE="Search">
<INPUT TYPE="hidden" NAME="SearchPage" VALUE="http://search.earthweb.com/search97/samples/forms/srchdemo.htm">
<INPUT TYPE="hidden" NAME="Collection" VALUE="ITK">
<INPUT TYPE="hidden" NAME="ResultTemplate" VALUE="itk-simple-intrabook.hts">
<INPUT TYPE="hidden" NAME="ViewTemplate" VALUE="view.hts">

<font face="arial, helvetica" size=2><b>Search this book:</b></font><br>
<INPUT NAME="queryText" size=50 VALUE="">&nbsp;<input type="submit" name="submitbutton" value="Go!">
<INPUT type=hidden NAME="section_on" VALUE="on">
<INPUT type=hidden NAME="section" VALUE="http://www.itknowledge.com/reference/standard/0471327565/">

</form>


<!-- Empty Reference Subhead -->

<!--ISBN=0471327565//-->
<!--TITLE=Developing Java Enterprise Applications//-->
<!--AUTHOR=Stephen Asbury//-->
<!--AUTHOR=Scott R. Weiner//-->
<!--PUBLISHER=Wiley Computer Publishing//-->
<!--CHAPTER=20//-->
<!--PAGES=524-529//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//-->

<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="20-10.html">Previous</A></TD>
<TD><A HREF="../ewtoc.html">Table of Contents</A></TD>
<TD><A HREF="20-12.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<P><BR></P>
<P>The remainder of the constructor creates the user interface.
</P>
<!-- CODE //-->
<PRE>
        setLayout(new GridLayout(2,1,6,6));

        queueField = new JTextField(20);
        queueField.addActionListener(this);
        queueField.setActionCommand(queue_action);

        label = new JLabel(&#147;Queue:&#148;);

        button = new JButton(&#147;Change&#148;);
        button.addActionListener(this);
        button.setActionCommand(queue_action);

        tmp = new JPanel();
        tmp.setLayout(new FlowLayout(FlowLayout.LEFT,6,0));

        label.setFont(f);
        queueField.setFont(f);
        button.setFont(f);

        tmp.add(label);
        tmp.add(queueField);
        tmp.add(button);

        add(tmp);

        sendField = new JTextField(20);
        sendField.addActionListener(this);
        sendField.setActionCommand(send_action);

        label = new JLabel(&#147;Message:&#148;);

        button = new JButton(&#147;Send&#148;);
        button.addActionListener(this);
        button.setActionCommand(send_action);

        tmp = new JPanel();
        tmp.setLayout(new FlowLayout(FlowLayout.LEFT,6,0));

        label.setFont(f);
        sendField.setFont(f);
        button.setFont(f);

        tmp.add(label);
        tmp.add(sendField);
        tmp.add(button);

        add(tmp);
    }
</PRE>
<!-- END CODE //-->
<P>Whenever the user changes the current queue, the setQueue method is called. This method makes sure that if we have a sender already, it is closed. Then the queue is looked up, by name, in the JNDI context. Remember that Queues are administered objects, so if a Queue doesn&#146;t exist, this operation will fail and cannot proceed. If the Queue is available, a sender is created for it.
</P>
<!-- CODE //-->
<PRE>
    public void setQueue(String name)
    {
        Queue queue=null;

        try
        {
            <B>if(sender!=null) sender.close();

            queue
             = (Queue) MiniJMSUtils.context.lookup(name);

            sender = session.createSender(queue);</B>

            if((queue == null)
                ||(sender==null)) throw new Exception();
        }
        catch(Exception exp)
        {
            exp.printStackTrace();
            System.exit(0);
        }
    }
</PRE>
<!-- END CODE //-->
<P>When the user presses the Send button, it triggers the sendMessage method to be called with the contents of the send text field. This method uses the session to create a new TextMessage and sets the message&#146;s contents to the text field&#146;s contents. Then the sender is used to send the message. If an error occurs, a warning is displayed to the user.
</P>
<!-- CODE //-->
<PRE>
    public void sendMessage(String text)
    {
        TextMessage msg;

        try
        {
                <B>msg = session.createTextMessage();
                msg.setText(text);
                sender.send(msg);</B>
        }
        catch(Exception exp)
        {
            JOptionPane.showMessageDialog(this
                                     ,exp.toString()
                                     ,&#147;Send Error&#148;
                                     ,JOptionPane.ERROR_MESSAGE);
        }
    }
</PRE>
<!-- END CODE //-->
<P>The actionPerformed method is defined to handle user interactions and calls the setQueue and sendMessage methods appropriately.
</P>
<!-- CODE //-->
<PRE>
    public void actionPerformed(ActionEvent evt)
    {
        String cmd = evt.getActionCommand();

        if(send_action.equals(cmd))
        {
            sendMessage(sendField.getText());
        }
        else if(queue_action.equals(cmd))
        {
            setQueue(queueField.getText());
        }
    }
</PRE>
<!-- END CODE //-->
<P>QueueSenderTest defines a close method that cleans up the JMS resources. This method will be called when the user closes the window for this application.
</P>
<!-- CODE //-->
<PRE>
    public void close()
    {
        try
        {
            sender.close();
            session.close();
            conn.close();
        }
        catch(Exception exp)
        {
            exp.printStackTrace();
        }
    }
</PRE>
<!-- END CODE //-->
<P>The main method creates a QueueSenderTest, using command-line arguments or a default for the user name. The user interface is displayed, and a window listener is assigned to the window to handle the close box. This listener calls the QueueSenderTest object&#146;s close method when the window is closed.
</P>
<!-- CODE //-->
<PRE>
    public static void main(String s[])
    {
        JFrame frame;
        QueueSenderTest panel;
        String user=&#147;QueueSenderTest&#148;;

        if(s.length&gt;0) user = s[0];

        frame = new JFrame(user);

        panel = new QueueSenderTest(user);

        //So we can catch errors in a log file
        System.setErr(System.out);

        frame.setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);
        frame.setForeground(Color.black);
        frame.setBackground(Color.lightGray);
        frame.getContentPane().add(panel,&#147;Center&#148;);

        frame.pack();
        frame.setVisible(true);
        frame.addWindowListener(new WindowCloser(panel));
    }
}
</PRE>
<!-- END CODE //-->
<P>WindowCloser is a convenience class provided to handle the window&#146;s close box and tell the QueueSenderTest to close its JMS resources. All of the JFC-based examples in this chapter have an object similar to this one to handle the window close.
</P>
<!-- CODE //-->
<PRE>
class WindowCloser extends WindowAdapter
{
    QueueSenderTest test;

    public WindowCloser(QueueSenderTest test)
    {
        this.test = test;
    }

    public void windowClosing(WindowEvent e)
    {

        Window win = e.getWindow();
        test.close();
        win.setVisible(false);
        System.exit(0);
    }
}
</PRE>
<!-- END CODE //-->
<P>If you run this example along with the MiniJMS server, you will be able to send messages to a queue. Currently, MiniJMS defines two default queues, named testqueue and errorqueue. Use these queues for testing.
</P>
<P>Two other examples of QueueSenders are included on the CD-ROM; both are very similar to QueueSenderTest. The first, called VolQueueSenderTest, is identical except for the sendMessage method. This method uses a different send method and marks the message as nonpersistent. The complete code for VolQueueSenderTest is available on the CD-ROM, but the sendMessage method follows:</P>
<!-- CODE //-->
<PRE>
public void sendMessage(String text)
{
    TextMessage msg;

    try
    {
            msg = session.createTextMessage();
            msg.setText(text);
            sender.send(msg
                        ,DeliveryMode.NON_PERSISTENT
                        ,Message.DEFAULT_PRIORITY
                        ,Message.DEFAULT_TIME_TO_LIVE);
    }
    catch(Exception exp)
    {
        JOptionPane.showMessageDialog(this
                                 ,exp.toString()
                                 ,&#147;Send Error&#148;
                                 ,JOptionPane.ERROR_MESSAGE);
    }
}
</PRE>
<!-- END CODE //-->
<P>The third example of a QueueSender extends the QueueSenderTest idea to include the use of a transacted Session. This required the addition of several buttons to the user interface, as pictured in Figure 20.3. To support transactions, the QueueSession is created using a true for the transacted argument in the QueueConnections createQueueSession method:
</P>
<!-- CODE //-->
<PRE>
try
{
    MiniJMSUtils.init(&#147;transqueuesender.properties&#148;);
    context = MiniJMSUtils.context;

    factory
   = (QueueConnectionFactory)
       context.lookup(&#147;QueueConnectionFactory&#148;);

    conn
     = factory.createQueueConnection(user,null);

    //Create a transacted session
    <B>session
     = conn.createQueueSession(true,Session.AUTO_ACKNOWLEDGE);</B>

    if(session == null) throw new Exception();
}
catch(Exception exp)
{
    exp.printStackTrace();
    System.exit(0);
}
</PRE>
<!-- END CODE //-->
<P><BR></P>
<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="20-10.html">Previous</A></TD>
<TD><A HREF="../ewtoc.html">Table of Contents</A></TD>
<TD><A HREF="20-12.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>


<!-- 
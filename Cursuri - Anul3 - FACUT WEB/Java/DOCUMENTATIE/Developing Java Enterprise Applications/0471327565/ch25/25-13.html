
<SCRIPT>
<!--
function displayWindow(url, width, height) {
        var Win = window.open(url,"displayWindow",'width=' + width +
	',height=' + height + ',resizable=1,scrollbars=yes');
	}
	//-->
	</SCRIPT>



<FONT FACE="Arial,Helvetica" SIZE="-1">
To access the contents, click the chapter and section titles.
</FONT>
<P>
<B>Developing Java Enterprise Applications</B>
<FONT SIZE="-1">
<BR>
<I>(Publisher: John Wiley & Sons, Inc.)</I>
<BR>
Author(s): Stephen Asbury ; Scott R. Weiner
<BR>
ISBN: 0471327565
<BR>
Publication Date: 02/01/99
</FONT>
<P>
<Script language="JavaScript">
function isIE4() 
{
    return( navigator.appName.indexOf("Microsoft") != -1 && (navigator.appVersion.charAt(0)=='4') );
 }
function bookMarkit()
{
        var url="http://www.itknowledge.com/PSUser/EWBookMarks.html?url="+window.location+"&isbn=0";
	parent.location.href=url;
        //var win = window.open(url,"myitk");
        //if(!isIE4())
        //       win.focus();

}
</Script>
<a href="javascript:bookMarkit();"><img src="/images/bookmarkit.gif" border=0 alt="Bookmark It" width=97 height=23></a>

<P>
<form name="Search" method="GET" action="http://search.earthweb.com/search97/search_redir.cgi">

<INPUT TYPE="hidden" NAME="Action" VALUE="Search">
<INPUT TYPE="hidden" NAME="SearchPage" VALUE="http://search.earthweb.com/search97/samples/forms/srchdemo.htm">
<INPUT TYPE="hidden" NAME="Collection" VALUE="ITK">
<INPUT TYPE="hidden" NAME="ResultTemplate" VALUE="itk-simple-intrabook.hts">
<INPUT TYPE="hidden" NAME="ViewTemplate" VALUE="view.hts">

<font face="arial, helvetica" size=2><b>Search this book:</b></font><br>
<INPUT NAME="queryText" size=50 VALUE="">&nbsp;<input type="submit" name="submitbutton" value="Go!">
<INPUT type=hidden NAME="section_on" VALUE="on">
<INPUT type=hidden NAME="section" VALUE="http://www.itknowledge.com/reference/standard/0471327565/">

</form>


<!-- Empty Reference Subhead -->

<!--ISBN=0471327565//-->
<!--TITLE=Developing Java Enterprise Applications//-->
<!--AUTHOR=Stephen Asbury//-->
<!--AUTHOR=Scott R. Weiner//-->
<!--PUBLISHER=Wiley Computer Publishing//-->
<!--CHAPTER=25//-->
<!--PAGES=664-667//-->
<!--UNASSIGNED1//-->
<!--UNASSIGNED2//-->

<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="25-12.html">Previous</A></TD>
<TD><A HREF="../ewtoc.html">Table of Contents</A></TD>
<TD><A HREF="25-14.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>
<P><BR></P>
<P>Because the purchase has occurred, the shopping cart is cleaned out so that the client can begin shopping anew.
</P>
<!-- CODE //-->
<PRE>
    protected void doPurchase(Hashtable items
                                ,ShoppingCart cart
                                ,Hashtable oldCartItems
                                ,String user
                                ,PrintWriter out
                                ,String requestURL
                                ,String referer)
    {
        ShoppingCartItem item;
        ShoppingCartItem curItem;
        ShoppingCartItem cartItems[]=null;
        int i,max=0;
        Enumeration curItems;
        float total=0;
        boolean failed=false;
        boolean badCredit=false;
        
        curItems = items.elements();
        try
        {
            while((curItems!=null)&amp&amp(curItems.hasMoreElements()))
            {
                curItem = (ShoppingCartItem) curItems.nextElement();
                cart.addItem(curItem);
            }
        }
        catch(Exception exp)
        {
            failed = true;
        }

        if(!failed)
        {
            try
            {
                if(!cart.purchaseCart(user)) failed = true;
            }
            catch(BadCreditException exp)
            {
                failed = true;
                badCredit = true;
            }
            catch(Exception exp)
            {
                failed = true;
            }
        }

        if(failed)
        {
            if(badCredit)
            {
                outputErrorMessage(out
                    ,&#147;You do not have enough credit"
                          +&#147; to make this purchase."
                    ,referer);
            }
            else
            {
                outputErrorMessage(out
                    ,&#147;Server failure, unable to purchase items."
                    ,referer);
            }
            
            return;
        }
    
        out.println(&#147;&ltHTML&gt");
        out.println(&#147;&ltHEAD&gt");
        out.println(&#147;&ltTITLE&gt");
        out.println(&#147;Purchase Confirmed");
        out.println(&#147;&lt/TITLE&gt");
        out.println(&#147;&lt/HEAD&gt");
        out.println(&#147;&ltBODY TEXT=\"#000000\&#147; BGCOLOR=\"#FFFFFF\"");
        out.println(" LINK=\"#FF0000\" VLINK=\"#800080\"&gt");
        out.println("&ltCENTER&gt");
        out.println("&ltTABLE WIDTH=500 BORDER=0&gt");
        out.println("&ltTR&gt");
        out.println("&ltTD&gt");
        
        out.println("&ltCENTER&gt&ltH1&gtPurchase Confirmed&lt/H1&gt&lt/CENTER&gt");
        out.print("Thank you for your purchase of the ");
        out.println("following items:&ltBR&gt");
        out.println("&ltTABLE&gt");
        out.println("&ltTR&gt");
        out.println("&ltTH&gtDescription&lt/TH&gt");
        out.println("&ltTH&gtQuantity&lt/TH&gt");
        out.println("&ltTH&gtPrice&lt/TH&gt");
        out.println("&ltTH&gtTotal&lt/TH&gt");
        out.println("&lt/TR&gt");
        
        try
        {
            cartItems = cart.getItems();
        }
        catch(Exception exp)
        {
        }
        
        if(cartItems != null) max = cartItems.length;
        
        for(i=0;i&ltmax;i++)
        {
            curItem = cartItems[i];
        
            if(curItem.quantity &gt 0)
            {
                out.println("&ltTR&gt");
                out.print("&ltTD&gt");
                out.print(curItem.desc);
                out.println("&lt/TD&gt");
                out.print("&ltTD&gt");
                out.print(curItem.quantity);
                out.println("&lt/TD&gt");
                out.print("&ltTD&gt");
                out.print(formatter.format(curItem.price));
                out.println("&lt/TD&gt");
                out.print("&ltTD&gt");
                out.print(formatter.format(curItem.getTotal()));
                out.println("&lt/TD&gt");
                out.println("&lt/TR&gt");
        
                total += curItem.getTotal();
            }
        }
        
        out.println("&ltTR&gt");
        out.println("&ltTD&gt&lt/TD&gt");
        out.println("&ltTD&gt&lt/TD&gt");
        out.println("&ltTD&gt&ltB&gtTotal&lt/B&gt&lt/TD&gt");
        out.print("&ltTD&gt&ltB&gt");
        out.print(formatter.format(total));
        out.println("&lt/B&gt&lt/TD&gt");
        out.println("&lt/TR&gt");

        out.println("&lt/TABLE&gt");
        
        if((referer!=null)&amp&amp(referer.length()&gt0))
        {
            out.print("&ltCENTER&gt&ltH4&gt&ltA HREF=\"");
            out.print("/shopcart/home/index.jhtml");
            out.println("\"&gtBack To Store Front&lt/A&gt&lt/H4&gt&lt/CENTER&gt");
        }
        
        out.println("&lt/TD&gt");
        out.println("&lt/TR&gt");
        out.println("&lt/TABLE&gt");
        out.println("&lt/CENTER&gt");
        out.println("&lt/BODY&gt");
        out.println("&lt/HTML&gt");
        out.close();
        
        //reset the cart
        oldCartItems.clear();
    }
}
</PRE>
<!-- END CODE //-->
<P>This servlet is rather long because of the HTML it contains. We have kept the code together in this example to make it easier to understand. In a larger commercial version of the same servlet, rather than add any more features, a store requiring more actions might consider breaking the responsibility for managing the cart into several servlets. This would make it easier for the programmer to maintain the site.
</P>
<H4 ALIGN="LEFT"><A NAME="Heading12"></A><FONT COLOR="#000077">Inventory Report</FONT></H4>
<P>The final servlet in this example is called Inventory Servlet. This servlet uses the ShoppingCart bean to retrieve the current inventory and display it. All of the code from this servlet should look familiar to you after reading the description of the ShoppingCartServlet.
</P>
<!-- CODE //-->
<PRE>
package shopcart.servlets;
 
//imports removed to save space

public class InventoryServlet extends HttpServlet
implements SingleThreadModel
{
    protected Context ctx;
    protected ShoppingCartHome home;
    protected DebugLog logger;
    protected NumberFormat formatter;
</PRE>
<!-- END CODE //-->
<P>The init methods sets up the connection to the debug server and the ShoppingCartHome.
</P>
<!-- CODE //-->
<PRE>
    public void init(ServletConfig config) throws ServletException
     {
        super.init(config);
        
        String logServer;
        
        logServer = getInitParameter(&#147;logserver&#148;);
        
        logger = new DebugLog();
        logger.logTo(logServer);
        
        formatter = NumberFormat.getCurrencyInstance();
        
        findHome();
    }
</PRE>
<!-- END CODE //-->
<P><BR></P>
<CENTER>
<TABLE BORDER>
<TR>
<TD><A HREF="25-12.html">Previous</A></TD>
<TD><A HREF="../ewtoc.html">Table of Contents</A></TD>
<TD><A HREF="25-14.html">Next</A></TD>
</TR>
</TABLE>
</CENTER>


<!-- 